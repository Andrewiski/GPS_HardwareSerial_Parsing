<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <title>GPS Monitor</title>
        <style>
            #map {
                height: 700px;
                width: 100%;
            }
        </style>
        <script type="text/javascript" src="/jquery-3.5.0.min.js"></script>
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBP-sX_MQ4FVCbm2v478-vEcubrio73lS4"></script>
        <script>
            var refreshRate = 10000;
            var map = null;
            var marker = null;
            var infoWindow = null;
            var position = {
                lat: 42.091560,
                lng: -85.584000
            };
            var mapCenter = {
                lat: 42.091560,
                lng: -85.584000
            };
			
			
			var trackPath;
            function initMap() {
                map = new google.maps.Map(document.getElementById('map'),{
                    zoom: 4,
                    center: mapCenter
                });
				if(infoWindow === null){
							infoWindow = new google.maps.InfoWindow;
			                infoWindow.setPosition(position);
			                infoWindow.setContent('Hello! ');
			                infoWindow.open(map);
						}
                
                
				trackPath = new google.maps.Polyline({
				    geodesic: true,
				    strokeColor: '#FF0000',
				    strokeOpacity: 1.0,
				    strokeWeight: 2
				  });
			   trackPath.setMap(map);

            };
			function centerMapCurrentPosition() {
			    var path = trackPath.getPath();
                console.log("Getting Position");
                $.ajax({
                    url: "/getGpsData",
                    dataType: "json",
                    data: null
                }).then(function(data) {
                    if (data.valid) {
					
					    
                        console.log("Got Position", data);
                        position.lat = data.lat;
						position.lng = data.lng;
						path.push(position);
						
						if(marker === null){
							marker = new google.maps.Marker({
			                    position: position,
			                    map: map
			                });
						};
						marker.setPosition(position);
					/*	if(infoWindow === null){
							infoWindow = new google.maps.InfoWindow;
			                infoWindow.setPosition(position);
			                infoWindow.setContent('New location found.');
			                infoWindow.open(map);
						}
						infoWindow.setPosition(position);*/
						
                    } else {
                        console.log("No Gps Fix", data);
                    };
                    //setTimeout(updateMap, refreshRate);
                }, function(jqXHR, textStatus, errorThrown) {
                    console.log("Error Getting Position", textStatus, errorThrown);
                    //setTimeout(updateMap, refreshRate);
                });
            }
	    var getMenu = function(){
		$( "div.menu" ).load( "/autoconnectMenu" );
            }
            $(document).ready(function() {
				$(".btnCurrentPosition").on("click", centerMapCurrentPosition);
				getMenu();
                initMap();
                centerMapCurrentPosition();
            });
        </script>
    </head>
    <body>
	
        <div style="width:100%">
		    <div style="display:inline-block"><h3>Teo Google Maps Demo</h3></div>
			<div style="display:inline-block"><button class="btnCurrentPosition">!</button></div>
			<div style="display:inline-block; float:right"><div class="menu"></div></div>
	    </div>
		<div style="width:100%">
			<table style="width:100%">
				<tr>
					<td style="width:100px"><div class="files"></div></td>
					<td><div id="map"></div></td>
				</tr>
			</table>
		</div>
        
    </body>
</html>
